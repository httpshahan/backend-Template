name: Deploy to Staging (Develop)

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
  RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: backend_template_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for services
        run: |
          sleep 10
          mysql -h 127.0.0.1 -u root -proot -e "SELECT 1"
          redis-cli -h 127.0.0.1 ping

      - name: Run migrations
        run: npm run db:migrate
        env:
          NODE_ENV: test
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASS: root
          DB_NAME: backend_template_test
          JWT_SECRET: test-secret-key

      - name: Run tests
        run: npm test
        env:
          NODE_ENV: test
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASS: root
          DB_NAME: backend_template_test
          JWT_SECRET: test-secret-key
          REDIS_HOST: 127.0.0.1
          REDIS_PORT: 6379

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3

  staging-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit_info
        run: |
          echo "commit_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Start staging deployment notification
        run: |
          echo "ğŸš€ Starting STAGING deployment to Render..."
          echo "ğŸ“¦ Commit: ${{ steps.commit_info.outputs.commit_sha }}"
          echo "ğŸ‘¤ Author: ${{ steps.commit_info.outputs.author }}"
          echo "ğŸ’¬ Message: ${{ steps.commit_info.outputs.commit_message }}"
          echo "ğŸŒ¿ Branch: develop â†’ STAGING"

      - name: Deploy to Render Staging
        id: deploy
        uses: johnbeynon/render-deploy-action@v0.0.8
        with:
          service-id: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
          api-key: ${{ secrets.RENDER_API_KEY }}
          wait-for-success: true

      - name: Staging Deployment Success
        if: success()
        run: |
          echo "âœ… STAGING deployment successful!"
          echo "ğŸŒ Staging URL: https://${{ secrets.RENDER_STAGING_APP_URL }}"
          echo "â° Deployed at: $(date)"

      - name: Staging Deployment Failed
        if: failure()
        run: |
          echo "âŒ STAGING deployment failed!"
          echo "ğŸ” Check the logs above for details"
          exit 1

      - name: Notify Staging Deployment Status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ${{ job.status == 'success' && 'âœ… STAGING Deployment Successful' || 'âŒ STAGING Deployment Failed' }}
            Repository: ${{ github.repository }}
            Branch: develop â†’ STAGING
            Commit: ${{ steps.commit_info.outputs.commit_sha }}
            Author: ${{ steps.commit_info.outputs.author }}
            URL: https://${{ secrets.RENDER_STAGING_APP_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  staging-health-check:
    needs: staging-deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
      - name: Wait for staging deployment to stabilize
        run: |
          echo "â³ Waiting for STAGING deployment to stabilize..."
          sleep 45

      - name: Staging Health Check
        id: health_check
        run: |
          echo "ğŸ” Performing STAGING health check..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.RENDER_STAGING_APP_URL }}/api/v1/health)
            if [ $response -eq 200 ]; then
              echo "âœ… STAGING health check passed (attempt $i)"
              break
            else
              echo "âš ï¸  STAGING health check failed with status code: $response (attempt $i)"
              if [ $i -eq 5 ]; then
                echo "âŒ STAGING health check failed after 5 attempts"
                exit 1
              fi
              sleep 10
            fi
          done

      - name: Staging API Integration Test
        run: |
          echo "ğŸ§ª Running STAGING API integration tests..."

          # Generate random email for test
          TEST_EMAIL="staging-test-$(date +%s)@example.com"

          # Test registration endpoint
          echo "ğŸ“ Testing user registration on STAGING..."
          registration_response=$(curl -s -X POST https://${{ secrets.RENDER_STAGING_APP_URL }}/api/v1/auth/register \
            -H "Content-Type: application/json" \
            -d "{\"firstName\":\"Staging\",\"lastName\":\"Test\",\"email\":\"$TEST_EMAIL\",\"password\":\"TestPass123!\"}" \
            -w "%{http_code}")

          echo "STAGING registration response: $registration_response"

          if [[ "$registration_response" =~ 201$ ]]; then
            echo "âœ… STAGING registration test passed"
          else
            echo "âŒ STAGING registration test failed"
            exit 1
          fi

      - name: Staging Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š STAGING Deployment Summary"
          echo "=============================="
          echo "ğŸŒ Staging URL: https://${{ secrets.RENDER_STAGING_APP_URL }}"
          echo "ğŸ“¦ Deployed Commit: ${GITHUB_SHA::7}"
          echo "ğŸŒ¿ Branch: develop"
          echo "ğŸ‘¤ Author: $(git log -1 --pretty=%an)"
          echo "â° Deployed at: $(date)"
          echo "âœ… Status: ${{ job.status == 'success' && 'SUCCESS' || 'FAILED' }}"
          echo ""
          echo "ğŸš€ Ready for testing! Once verified, merge to main for production deployment."
